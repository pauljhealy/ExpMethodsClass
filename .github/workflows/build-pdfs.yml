name: Build Lecture PDFs and Index

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Check out repo
        uses: actions/checkout@v4

      # 2️⃣ Find all standalone .tex files in LectureSlides
      - name: Find lecture .tex files
        run: |
          mkdir -p build
          find LectureSlides -maxdepth 1 -name "00_mwe.tex" > texfiles.txt
          echo "Found the following .tex files:"
          cat texfiles.txt

      # 3️⃣ Compile each .tex into a PDF
      - name: Compile lecture PDFs
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-fonts-extra latexmk poppler-utils

          while IFS= read -r texfile; do
            echo "Compiling $texfile ..."
            latexmk -pdf -interaction=nonstopmode -halt-on-error -outdir=build "$texfile"
          done < texfiles.txt

      # 4️⃣ Move PDFs to public/
      - name: Collect PDFs
        run: |
          mkdir -p public
          mv build/*.pdf public/

      # 5️⃣ Generate index.html from PDF titles
      - name: Generate index.html
        run: |
          echo "<!DOCTYPE html>" > public/index.html
          echo "<html><head><meta charset='utf-8'><title>Lecture Slides</title></head><body>" >> public/index.html
          echo "<h1>Lecture Slides</h1><ul>" >> public/index.html

          for f in public/*.pdf; do
            filename=$(basename "$f")
            title=$(pdfinfo "$f" | awk -F': *' '/^Title/ {print $2}')

            # Fallback to filename if PDF metadata Title is empty
            if [ -z "$title" ]; then
              title="${filename%.pdf}"
            fi

            echo "<li><a href=\"$filename\">$title</a></li>" >> public/index.html
          done

          echo "</ul></body></html>" >> public/index.html

      # 6️⃣ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
