name: Build Lecture PDFs and Index

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Check out repo
        uses: actions/checkout@v4

      # 2️⃣ Find all standalone .tex files in LectureSlides
      - name: Find lecture .tex files
        run: |
          mkdir -p build
          find LectureSlides -maxdepth 1 -name "*.tex" \
          ! -path "LectureSlides/includes/*" \
          | sort > texfiles.txt
          echo "Found the following .tex files:"
          cat texfiles.txt
          find Syllabus -maxdepth 1 -name "syllabus.tex" > syllabuspath.txt
          echo "Found the syllabus .tex file:"
          cat syllabuspath.txt

      # 3️⃣ Compile each .tex into a PDF
      - name: Compile lecture PDFs
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended texlive-fonts-extra texlive-games texlive-pstricks texlive-pictures texlive-science texlive-bibtex-extra latexmk poppler-utils gnuplot

          while IFS= read -r texfile; do
            echo "Compiling $texfile ..."
            latexmk -pdf -shell-escape -interaction=nonstopmode -halt-on-error -outdir=build "$texfile"
          done < texfiles.txt
          
          while IFS= read -r texfile; do
            echo "Compiling $texfile ..."
            latexmk -pdf -interaction=nonstopmode -halt-on-error -outdir=build "$texfile"
          done < syllabuspath.txt

      # 4️⃣ Move PDFs to public/
      - name: Collect PDFs
        run: |
          mkdir -p public
          mv build/*.pdf public/

      # 5️⃣ Generate index.html from PDF titles
      - name: Generate index.html
        run: |
          echo "<!DOCTYPE html>" > public/index.html
          echo "<html><head><meta charset='utf-8'><title>Lecture Slides</title></head><body>" >> public/index.html
          echo "<h2>Syllabus</h2><ul>" >> public/index.html
          echo "<li><a href=\"syllabus.pdf\">Syllabus</a></li>" >> public/index.html
          echo "</ul><br>" >> public/index.html
          echo "<h2>Lecture Slides</h2><ul>" >> public/index.html

          for f in public/*.pdf; do
            filename=$(basename "$f")
            if [ "$filename" = "syllabus.pdf" ]; then
              continue
            fi

            base="${filename%.pdf}"
            texfile="LectureSlides/$base.tex"
            
            raw_title=$(pdfinfo "$f" \
              | awk '/^Title:/ {flag=1; sub(/^Title:[[:space:]]*/, ""); print; next}
                     /^[[:space:]]/ && flag {print}
                     !/^[[:space:]]/ && flag {exit}')

            # Normalize
            title=$(printf "%s" "$raw_title" \
              | tr '\n' ' ' \
              | sed 's/\\\\/ /g' \
              | sed 's/[[:space:]]\+/ /g' \
              | sed 's/^ *//; s/ *$//')

            # Fallback to filename if empty
            if [ -z "$title" ]; then
              title=$(basename "$f" .pdf)
            fi

            echo "<li><a href=\"$filename\">$title</a> (<a href=\"$texfile\">LaTeX source</a>)</li>" >> public/index.html
          done

          echo "</ul></body></html>" >> public/index.html

      # 6️⃣ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
